export const glossaryTerms = {
    'On-Premise': 'Imagina que tienes tus juguetes guardados en tu propia habitación. "On-Premise" significa que los programas y la información de una empresa están guardados en sus propias computadoras, dentro de su oficina.',
    'Cloud-Native': 'Es como si tus juguetes no estuvieran en tu habitación, sino en una gran juguetería mágica en el cielo (la "nube"). "Cloud-Native" significa que los programas están hechos para funcionar directamente en esa juguetería mágica, aprovechando todo lo que ofrece.',
    'VLANs': 'Piensa en tu casa con varias habitaciones. Cada habitación es para algo diferente (dormir, jugar, comer). Las "VLANs" son como crear habitaciones virtuales dentro de la red de una empresa para separar diferentes tipos de computadoras y que no se mezclen, haciendo todo más ordenado y seguro.',
    'NGFW': 'Un "NGFW" (Firewall de Nueva Generación) es como un súper guardián en la puerta de tu casa que no solo ve quién entra y sale, sino que también revisa qué llevan y qué hacen para asegurarse de que no haya nada malo. Es mucho más inteligente que un guardián normal.',
    'EDR': 'Un "EDR" (Detección y Respuesta de Endpoint) es como un detective muy listo que vive dentro de cada una de las computadoras de la empresa. Siempre está observando lo que pasa para encontrar cosas raras o peligrosas y avisar rápido para detener a los "malos".',
    'MFA': 'La "MFA" (Autenticación Multifactor) es como tener dos cerraduras en tu puerta en lugar de una. Para entrar, no solo necesitas tu llave (contraseña), sino también otra cosa, como un código que te llega al teléfono. Así es mucho más difícil que alguien entre sin permiso.',
    'ERP': 'Un "ERP" (Planificación de Recursos Empresariales) es como un cerebro gigante para toda la empresa. Ayuda a organizar y conectar todas las partes del negocio, como las ventas, las compras, el dinero y los productos, para que todo funcione junto y de forma inteligente.',
    'DRP': 'Un "DRP" (Plan de Recuperación de Desastres) es como un plan de emergencia muy detallado. Si algo muy malo pasa (como un incendio o un virus gigante), este plan dice exactamente qué hacer para que la empresa pueda volver a funcionar lo más rápido posible y no pierda su información.',
    'OT': 'La "OT" (Tecnología Operacional) es como el cerebro de las máquinas que hacen cosas en una fábrica, como los robots o las máquinas que empaquetan productos. Se encarga de que todo funcione bien en el mundo real, no solo en las computadoras de oficina.',
    'SCADA': 'Un sistema "SCADA" es como el panel de control principal de una fábrica o una planta de agua. Desde ahí, puedes ver y controlar todas las máquinas y procesos grandes, como si tuvieras un control remoto gigante para todo el lugar.',
    'MSP': 'Un "MSP" (Proveedor de Servicios Gestionados) es como un equipo de superhéroes de la tecnología que una empresa contrata para que se encarguen de todas sus computadoras, redes y programas, para que la empresa no tenga que preocuparse por eso.',
    'DPI': 'La "DPI" (Inspección Profunda de Paquetes) es como cuando el guardián de tu casa no solo ve el sobre de una carta, sino que abre la carta y lee todo lo que dice para asegurarse de que no haya nada peligroso dentro.',
    'IPS': 'Un "IPS" (Sistema de Prevención de Intrusiones) es como un policía muy rápido que está en la puerta de tu red. Si ve que alguien intenta entrar sin permiso o hacer algo malo, lo detiene al instante antes de que cause problemas.',
    'VPN': 'Una "VPN" (Red Privada Virtual) es como un túnel secreto y seguro que creas en internet. Cuando lo usas, es como si estuvieras en la oficina, aunque estés en tu casa o en una cafetería, y nadie puede ver lo que haces en ese túnel.',
    'ZTNA': 'La "ZTNA" (Acceso a la Red de Confianza Cero) es como un guardia de seguridad que no confía en nadie, ni siquiera en los que ya están dentro. Cada vez que alguien quiere acceder a algo, el guardia lo revisa de nuevo para asegurarse de que tiene permiso y es seguro.',
    'DDoS': 'Un ataque "DDoS" (Denegación de Servicio Distribuido) es como si miles de personas intentaran entrar a la vez por la puerta de una tienda muy pequeña. La tienda se colapsa y nadie puede entrar. En internet, esto hace que una página web o un servicio deje de funcionar.',
    'MDM': 'Un "MDM" (Gestión de Dispositivos Móviles) es como un control remoto para todos los teléfonos y tabletas de la empresa. Permite a los encargados de TI configurarlos, protegerlos y borrar información si se pierden, todo desde un solo lugar.',
    'UEM': 'Un "UEM" (Gestión Unificada de Endpoints) es como un control remoto aún más grande que el MDM. No solo controla teléfonos y tabletas, sino también computadoras portátiles y de escritorio, para que todo esté seguro y organizado desde un solo lugar.',
    'PAM': 'La "PAM" (Gestión de Acceso con Privilegios) es como tener una caja fuerte especial para las llaves más importantes de la empresa. Solo unas pocas personas tienen acceso a esas llaves, y cada vez que las usan, queda registrado para saber quién hizo qué.',
    '2FA': 'La "2FA" (Autenticación de Dos Factores) es lo mismo que la MFA. Es como tener dos cerraduras en tu puerta. Necesitas tu llave (contraseña) y otra cosa más (como un código del teléfono) para poder entrar.',
    'RGPD': 'El "RGPD" (Reglamento General de Protección de Datos) es como un conjunto de reglas muy importantes que dicen cómo las empresas deben cuidar la información personal de las personas, como sus nombres, direcciones o fotos. Es para proteger tu privacidad.',
    'WMS': 'Un "WMS" (Sistema de Gestión de Almacenes) es como un organizador muy inteligente para un almacén. Sabe dónde está cada producto, cuándo llegó, cuándo sale y ayuda a que todo se mueva de forma rápida y sin errores.',
    'RFID': 'La "RFID" (Identificación por Radiofrecuencia) es como ponerle una pequeña etiqueta mágica a los productos. Esta etiqueta puede ser leída por una antena sin necesidad de tocarla, lo que ayuda a saber dónde están las cosas muy rápido, como en un almacén grande.',
    'PLCs': 'Los "PLCs" (Controladores Lógicos Programables) son como pequeños cerebros de computadora que controlan máquinas específicas en una fábrica, como las que llenan botellas o mueven brazos robóticos. Les dices qué hacer y ellos lo hacen una y otra vez.',
    'DMZ': 'Una "DMZ" (Zona Desmilitarizada) es como un área de espera segura entre la calle (internet) y tu casa (la red de la empresa). Aquí se ponen los servidores que necesitan ser vistos desde internet, pero si alguien los ataca, no pueden llegar fácilmente al resto de la red interna.'
};

export function highlightTerms() {
    const reportContent = document.querySelector('main');
    if (!reportContent) return;

    const walk = document.createTreeWalker(reportContent, NodeFilter.SHOW_TEXT, null, false);
    let node;
    const terms = Object.keys(glossaryTerms).sort((a, b) => b.length - a.length); // Sort by length to match longer terms first

    while ((node = walk.nextNode())) {
        let text = node.nodeValue;
        let replaced = false;

        for (const term of terms) {
            const escapedTerm = term.replace(/[.*+?^${}()|[\\\]]/g, '\$&');
            const regex = new RegExp(`\b(${escapedTerm})\b`, 'gi');

            if (regex.test(text)) {
                const fragment = document.createDocumentFragment();
                let lastIndex = 0;
                let match;

                while ((match = regex.exec(text)) !== null) {
                    // Append text before the match
                    if (match.index > lastIndex) {
                        fragment.appendChild(document.createTextNode(text.substring(lastIndex, match.index)));
                    }

                    // Append the highlighted term
                    const span = document.createElement('span');
                    span.className = 'glossary-term';
                    span.dataset.term = term;
                    span.textContent = match[0]; // Use match[0] to preserve original casing
                    
                    // Add click event listener
                    span.addEventListener('click', () => {
                        showGlossaryModal(term, glossaryTerms[term]);
                    });

                    fragment.appendChild(span);

                    lastIndex = regex.lastIndex;
                }

                // Append any remaining text after the last match
                if (lastIndex < text.length) {
                    fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                }

                node.parentNode.replaceChild(fragment, node);
                replaced = true;
                break; // Break after first term match to avoid re-processing the same node
            }
        }
        // If the node was replaced, the TreeWalker's internal pointer might be off.
        // Resetting it to the parent of the replaced node ensures we don't skip anything.
        if (replaced) {
            walk.currentNode = node.parentNode;
        }
    }
}

export function setupGlossaryHover() {
    const glossaryWidget = document.getElementById('glossary-widget');
    const glossaryTermDisplay = document.getElementById('glossary-definition');
    const glossaryDefinitionDisplay = document.getElementById('glossary-definition');

    // Event delegation for better performance and handling dynamically added elements
    document.addEventListener('mouseover', (event) => {
        if (event.target.classList.contains('glossary-term')) {
            const term = event.target.dataset.term;
            glossaryTermDisplay.textContent = term;
            glossaryDefinitionDisplay.textContent = glossaryTerms[term];
            glossaryWidget.classList.remove('hidden');

            const mouseX = event.clientX;
            const mouseY = event.clientY;

            const widgetWidth = glossaryWidget.offsetWidth;
            const widgetHeight = glossaryWidget.offsetHeight;

            let posX = mouseX + 15;
            let posY = mouseY + 15;

            if (posX + widgetWidth > window.innerWidth) {
                posX = window.innerWidth - widgetWidth - 10;
            }
            if (posY + widgetHeight > window.innerHeight) {
                posY = window.innerHeight - widgetHeight - 10;
            }
            if (posX < 10) {
                posX = 10;
            }
            if (posY < 10) {
                posY = 10;
            }

            glossaryWidget.style.left = `${posX}px`;
            glossaryWidget.style.top = `${posY}px`;
        }
    });

    document.addEventListener('mouseout', (event) => {
        if (event.target.classList.contains('glossary-term')) {
            // Add a small delay to allow moving from term to widget without hiding
            setTimeout(() => {
                if (!event.relatedTarget || !glossaryWidget.contains(event.relatedTarget)) {
                    glossaryWidget.classList.add('hidden');
                }
            }, 100);
        }
    });

    // Keep widget visible if mouse is over it
    glossaryWidget.addEventListener('mouseover', () => {
        glossaryWidget.classList.remove('hidden');
    });

    glossaryWidget.addEventListener('mouseout', () => {
        glossaryWidget.classList.add('hidden');
    });
}